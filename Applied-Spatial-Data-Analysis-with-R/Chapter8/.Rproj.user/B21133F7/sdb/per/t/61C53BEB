{
    "contents" : "### R code from vignette source 'geos.Rnw'\n### Encoding: UTF-8\n# data: m1m2.R\n###################################################\n### code chunk number 1: geos.Rnw:8-19\n###################################################\nrequire(RColorBrewer)\nrequire(lattice)\npal = function(n = 9) brewer.pal(n, \"Reds\")\n\n\n###################################################\n### code chunk number 11: geos.Rnw:169-175\n###################################################\n#trellis.par.set(canonical.theme(color = FALSE))\nlibrary(sp)\ndata(meuse)\ncoordinates(meuse) <- c(\"x\", \"y\")\n\nspplot(meuse, \"zinc\", do.log = T, colorkey = TRUE)\nbubble(meuse, \"zinc\", do.log = T, key.space = \"bottom\")\n\n\n###################################################\n### code chunk number 13: geos.Rnw:207-220\n###################################################\n\nxyplot(log(zinc) ~ sqrt(dist), as.data.frame(meuse))\n\n\n# print(xyplot(log(zinc)~sqrt(dist), as.data.frame(meuse), asp = .8), split = \n# c(1, 1,2,1), more = TRUE)\nzn.lm <- lm(log(zinc)~sqrt(dist), meuse)\nmeuse$fitted.s <- predict(zn.lm, meuse) - mean(predict(zn.lm, meuse))\nmeuse$residuals <- residuals(zn.lm)\n# print(spplot(meuse, c(\"fitted.s\", \"residuals\"), col.regions = \n#   pal(), cuts = 8, colorkey=TRUE), split = c(2,1,2,1))\nspplot(meuse, c(\"fitted.s\", \"residuals\"))\n\n###################################################\n### code chunk number 14: geos.Rnw:250-253\n###################################################\ndata(meuse.grid)\ncoordinates(meuse.grid) <- c(\"x\", \"y\")\nmeuse.grid <- as(meuse.grid, \"SpatialPixelsDataFrame\")\n\n\n###################################################\n### code chunk number 15: geos.Rnw:290-293\n###################################################\nlibrary(gstat)\nidw.out <- gstat::idw(zinc~1, meuse, meuse.grid, idp = 2.5)\nas.data.frame(idw.out)[1:5,]\n\n\n###################################################\n### code chunk number 16: geos.Rnw:320-323\n###################################################\nzn.lm <- lm(log(zinc)~sqrt(dist), meuse)\nmeuse.grid$pred <- predict(zn.lm, meuse.grid)\nmeuse.grid$se.fit <- predict(zn.lm, meuse.grid, se.fit=TRUE)$se.fit\n\n\n###################################################\n### code chunk number 17: geos.Rnw:337-338\n###################################################\nmeuse.lm <- krige(log(zinc)~sqrt(dist), meuse, meuse.grid)\n\n\n###################################################\n### code chunk number 18: geos.Rnw:364-365\n###################################################\nmeuse.tr2 <- krige(log(zinc)~1, meuse, meuse.grid, degree = 2)\n\n\n###################################################\n### code chunk number 19: geos.Rnw:384-385 \n###################################################\nlm(log(zinc)~I(x^2)+I(y^2)+I(x*y) + x + y, meuse)\n\n\n###################################################\n### code chunk number 20: geos.Rnw:393-394 \n###################################################\nlm(log(zinc) ~ poly(x, y, degree = 2), meuse)\n\n\n###################################################\n### code chunk number 22: geos.Rnw:515-521\n###################################################\nhscat(log(zinc)~1,meuse,(0:9)*100, pch=3, cex=.6, col = 'grey')\n\n\n###################################################\n### code chunk number 24: geos.Rnw:560-585\n###################################################\nlibrary(gstat)\ncld <- variogram(log(zinc) ~ 1, meuse, cloud = TRUE)\nsvgm <- variogram(log(zinc) ~ 1, meuse)\nd <- data.frame(gamma = c(cld$gamma, svgm$gamma),\n    dist = c(cld$dist, svgm$dist),\n    id = c(rep(\"cloud\", nrow(cld)), rep(\"sample variogram\", nrow(svgm)))\n    )\nxyplot(gamma ~ dist | id, d,\n    scales = list(y = list(relation = \"free\", \n\t  #ylim = list(NULL, c(-.005,0.7)))),\n\t  limits = list(NULL, c(-.005,0.7)))),\n    layout = c(1, 2), as.table = TRUE,\n    panel = function(x,y, ...) {\n        if (panel.number() == 2)\n            ltext(x+10, y, svgm$np, adj = c(0,0.5)) #$\n        panel.xyplot(x,y,...)\n    },\n    xlim = c(0, 1590),\n    cex = .5, pch = 3\n)\n\n\n###################################################\n### code chunk number 25: geos.Rnw:597-599 (eval = FALSE)\n###################################################\n## library(gstat)\n## variogram(log(zinc) ~ 1, meuse, cloud = TRUE)\n\n\n###################################################\n### code chunk number 26: geos.Rnw:626-628 (eval = FALSE)\n###################################################\nsel <- plot(variogram(zinc ~ 1, meuse, cloud = TRUE), digitize = TRUE)\nplot(sel, meuse)\n\n\n###################################################\n### code chunk number 27: geos.Rnw:664-694\n###################################################\nsel <-\nstructure(list(x = c(145.291968730077, 266.107479142605, 320.156523274526,\n339.232656497557, 323.335878811698, 212.058435010685, 135.753902118561,\n46.7319470777507, 78.5255024494688, 142.112613192905), y = c(574649.690841889,\n581256.265954825, 627502.29174538, 822396.257577002, 1053626.38652977,\n1278249.94036961, 1255126.92747433, 792666.669568789, 634108.866858316,\n577952.978398357)), .Names = c(\"x\", \"y\"))\nv <- variogram(zinc ~ 1, meuse, cloud = TRUE)\nv$gamma <- v$gamma/1e6\nsel$y <- sel$y/1e6\np1 <- xyplot(gamma~dist, v,\n    panel = function(x, y, ...) {\n        panel.xyplot(x, y, ...)\n        llines(sel$x, sel$y, col = 'red')\n    },\n    pch=3, cex = .5, asp = 1, ylab = \"gamma (x 1e6)\")\nx <-\nstructure(list(head = c(40, 40, 40, 54, 55, 54, 47, 80, 55, 55,\n54, 53, 54, 55, 59, 59), tail = c(41, 42, 43, 57, 57, 58, 59,\n99, 121, 122, 123, 125, 125, 125, 125, 132)), .Names = c(\"head\",\n\"tail\"), row.names = as.integer(c(NA, 16)), class = c(\"pointPairs\",\n\"data.frame\"))\np2 = plot(x, meuse, scales=list(draw=F), col.line = 'red')\nprint(p1, split = c(1,1,2,1), more = TRUE)\nprint(p2, split = c(2,1,2,1))\n\n\n###################################################\n### code chunk number 28: geos.Rnw:726-758\n###################################################\nv <- variogram(log(zinc) ~ 1, meuse)\n# INTERACTIVE mode out-commented:\n#plot(v, type = 'b', pch = 3)\n#fn = function(n = 100) {\n#        for (i in 1:n) {\n#           meuse$random = sample(meuse$zinc)\n#           v = variogram(log(random) ~ 1, meuse)\n#           trellis.focus(\"panel\", 1, 1, highlight = FALSE)\n#           llines(v$dist, v$gamma, col = 'grey')\n#           trellis.unfocus()\n#        }\n#}\n#fn()\n#trellis.focus(\"panel\", 1, 1, highlight = FALSE)\n#lpoints(v$dist, v$gamma, col = 'black', type = 'b', lwd = 2, pch=3)\n#trellis.unfocus()\nprint(xyplot(gamma ~ dist, v, pch = 3, type = 'b', lwd = 2, col = 'darkblue',\n    panel = function(x, y, ...) {\n        for (i in 1:100) {\n            meuse$random = sample(meuse$zinc)\n            v = variogram(log(random) ~ 1, meuse)\n            llines(v$dist, v$gamma, col = 'grey')\n        }\n        panel.xyplot(x, y, ...)\n    },\n    ylim = c(0, 0.75), xlab = 'distance', ylab = 'semivariance'\n))\n\n\n###################################################\n### code chunk number 29: geos.Rnw:770-771 \n###################################################\nplot(variogram(log(zinc) ~ 1, meuse))\n\n\n###################################################\n### code chunk number 30: geos.Rnw:789-790 \n###################################################\nplot(variogram(log(zinc) ~ 1, meuse, alpha = c(0, 45, 90, 135)))\n\n\n###################################################\n### code chunk number 31: geos.Rnw:850-851 \n###################################################\nplot(variogram(log(zinc) ~ 1, meuse, cutoff = 1000, width = 50))\n\n\n###################################################\n### code chunk number 32: geos.Rnw:866-867 \n###################################################\nvariogram(log(zinc) ~ 1, meuse, boundaries = c(0,50,100,seq(250,1500,250)))\n\n\n###################################################\n### code chunk number 33: geos.Rnw:903-905 \n###################################################\nshow.vgms()\nshow.vgms(model = \"Mat\", kappa.range = c(.1, .2, .5, 1, 2, 5, 10), max = 10)\n\n\n###################################################\n### code chunk number 34: geos.Rnw:931-937\n###################################################\nvgm(1, \"Sph\", 300)\nvgm(1, \"Sph\", 300, 0.5)\nv1 <- vgm(1, \"Sph\", 300, 0.5)\nv2 <- vgm(0.8, \"Sph\", 800, add.to = v1)\nv2\nvgm(0.5, \"Nug\", 0)\n\n\n###################################################\n### code chunk number 35: geos.Rnw:962-963\n###################################################\nvgm()\n\n\n###################################################\n### code chunk number 36: geos.Rnw:984-986 \n###################################################\nv <- variogram(log(zinc) ~ 1, meuse)\nplot(v)\n\n\n###################################################\n### code chunk number 37: geos.Rnw:1002-1003\n###################################################\nfit.variogram(v, vgm(1, \"Sph\", 800, 1))\n\n\n###################################################\n### code chunk number 38: geos.Rnw:1017-1018\n###################################################\nfit.variogram(v, vgm(1, \"Sph\", 10, 1))\n\n\n###################################################\n### code chunk number 39: geos.Rnw:1032-1035 (eval = FALSE)\n###################################################\n## v.fit <- fit.variogram(v, vgm(1, \"Sph\", 10, 1))\n## if (attr(v.fit, \"singular\"))\n##     stop(\"singular fit\")\n\n\n###################################################\n### code chunk number 40: geos.Rnw:1050-1081\n###################################################\nccol = 'darkblue' #grey(.5)\nv <- variogram(log(zinc) ~ 1, meuse)\nv.fit <- fit.variogram(v, vgm(1, \"Sph\", 800, 1))\nplot(v, v.fit, pch = 3, panel = function(x,y,subscripts,...) {\n\t\tlarrows(0,v.fit$psill[1], v.fit$range[2], v.fit$psill[1], \n\t\t\tcol=ccol, ends = 'both', length=.1, angle=15)\n\t\tlarrows(v.fit$range[2],0, v.fit$range[2], v.fit$psill[1], \n\t\t\tcol=ccol, ends = 'both', length=.1, angle=15)\n\t\tlarrows(v.fit$range[2],v.fit$psill[1], v.fit$range[2], \n\t\t\tsum(v.fit$psill), \n\t\t\tcol=ccol, ends = 'both', length=.1, angle=15)\n\t\tltext(v.fit$rang[2]/2, 1.2*v.fit$psill[1], \"range\", col=ccol,\n\t\t\tadj = c(.5, 0), cex=.9)\n\t\tltext(1.02 * v.fit$rang[2], 0.5 *v.fit$psill[1], \"nugget\", col=ccol,\n\t\t\tadj = c(0, 0.5), cex=.9)\n\t\tltext(1.02 * v.fit$rang[2], v.fit$psill[1] + 0.5 * v.fit$psill[2], \n\t\t\t\"partial sill\", col=ccol, adj = c(0, 0.5), cex=.9)\n\t\tvgm.panel.xyplot(x,y,subscripts,...)\n\t}\n)\n\n\n\n###################################################\n### code chunk number 41: geos.Rnw:1106-1107\n###################################################\nattr(v.fit, \"SSErr\")\n\n\n###################################################\n### code chunk number 42: geos.Rnw:1150-1153 (eval = FALSE)\n###################################################\n## library(geoR)\n## v.eye <- eyefit(variog(as.geodata(meuse[\"zinc\"]),max.dist=1500))\n## ve.fit <- as.vgm.variomodel(v.eye[[1]])\n\n\n###################################################\n### code chunk number 43: geos.Rnw:1185-1186\n###################################################\nfit.variogram(v, vgm(1, \"Sph\", 800, 0.06), fit.sills = c(FALSE, TRUE))\n\n\n###################################################\n### code chunk number 44: geos.Rnw:1207-1215\n###################################################\nv.dir <- variogram(log(zinc)~1,meuse,alpha=(0:3)*45)\nv.anis <- vgm(.6, \"Sph\", 1600, .05, anis=c(45,.3))\nprint(plot(v.dir, v.anis, pch=3))\n\n\n###################################################\n### code chunk number 45: geos.Rnw:1224-1225\n###################################################\nfit.variogram.reml(log(zinc)~1, meuse, model=vgm(0.6, \"Sph\", 800, 0.06))\n\n\n###################################################\n### code chunk number 46: geos.Rnw:1262-1264\n###################################################\nv.dir <- variogram(log(zinc)~1,meuse,alpha=(0:3)*45)\nv.anis <- vgm(.6, \"Sph\", 1600, .05, anis=c(45, 0.3))\n\n\n###################################################\n### code chunk number 47: geos.Rnw:1266-1267 \n###################################################\nplot(v.dir, v.anis)\n\n\n###################################################\n### code chunk number 48: geos.Rnw:1285-1286 \n###################################################\nplot(variogram(log(zinc)~1,meuse, map=TRUE, cutoff=1000, width=100))\n\n\n###################################################\n### code chunk number 49: geos.Rnw:1343-1350\n###################################################\ng <- gstat(NULL, \"logCd\", log(cadmium)~1, meuse)\ng <- gstat(g, \"logCu\", log(copper)~1, meuse)\ng <- gstat(g, \"logPb\", log(lead)~1, meuse)\ng <- gstat(g, \"logZn\", log(zinc)~1, meuse)\ng\nvm <- variogram(g)\nvm.fit <- fit.lmc(vm, g, vgm(1, \"Sph\", 800, 1))\n\n\n###################################################\n### code chunk number 51: geos.Rnw:1378-1384\n###################################################\nprint(plot(vm, vm.fit))\n\n\n###################################################\n### code chunk number 52: geos.Rnw:1397-1398\n###################################################\ncor(as.data.frame(meuse)[c(\"cadmium\", \"copper\", \"lead\", \"zinc\")])\n\n\n###################################################\n### code chunk number 54: geos.Rnw:1468-1474\n###################################################\nf <- log(zinc) ~ sqrt(dist)\nvt <- variogram(f, meuse)\nvt.fit <- fit.variogram(vt, vgm(1, \"Exp\", 300, 1))\nvt.fit\ng.wls <- gstat(NULL, \"log-zinc\", f, meuse, model=vt.fit, set = list(gls=1))\n(variogram(g.wls)$gamma - vt$gamma)/ mean(vt$gamma)\n\n\n###################################################\n### code chunk number 55: geos.Rnw:1571-1574\n###################################################\nlz.sk <- krige(log(zinc)~1, meuse, meuse.grid, v.fit, beta = 5.9)\nlz.ok <- krige(log(zinc)~1, meuse, meuse.grid, v.fit)\nlz.uk <- krige(log(zinc)~sqrt(dist), meuse, meuse.grid, vt.fit)\n\n\n###################################################\n### code chunk number 56: geos.Rnw:1617-1619\n###################################################\ncok.maps <- predict(vm.fit, meuse.grid)\nnames(cok.maps)\n\n\n###################################################\n### code chunk number 58: geos.Rnw:1644-1652\n###################################################\nprint(spplot.vcov(cok.maps, cuts=6, col.regions=pal(7)))\n\n\n###################################################\n### code chunk number 60: geos.Rnw:1676-1678\n###################################################\nvm2.fit <- vm.fit\nvm2.fit$model[[3]]$range  = c(0, 900)\n\n\n###################################################\n### code chunk number 61: geos.Rnw:1680-1684\n###################################################\nvm2.fit$set <- list(nocheck=1) \nx <- predict(vm2.fit, meuse.grid)\nnames(as.data.frame(x))\nany(as.data.frame(x)[c(2,4,6,8)] < 0)\n\n\n###################################################\n### code chunk number 62: geos.Rnw:1711-1724\n###################################################\ng.cc <- gstat(NULL, \"log.zinc\", log(zinc)~1, meuse, model = v.fit)\nmeuse.grid$distn <- meuse.grid$dist - mean(meuse.grid$dist) +\n   mean(log(meuse$zinc))\nvd.fit <- v.fit\nvov <- var(meuse.grid$distn) / var(log(meuse$zinc))\nvd.fit$psill <- v.fit$psill * vov\ng.cc <- gstat(g.cc, \"distn\", distn ~ 1, meuse.grid, nmax = 1, model=vd.fit,\n    merge = c(\"log.zinc\",\"distn\"))\nvx.fit <- v.fit\nvx.fit$psill <- sqrt(v.fit$psill * vd.fit$psill) *\n   cor(meuse$dist, log(meuse$zinc)) #$\ng.cc <- gstat(g.cc, c(\"log.zinc\", \"distn\"), model = vx.fit)\nx <- predict(g.cc, meuse.grid)\n\n\n###################################################\n### code chunk number 63: geos.Rnw:1740-1752\n###################################################\nx$lz.uk <- lz.uk$var1.pred\nx$lz.ok <- lz.ok$var1.pred\nprint(spplot(x, c(\"log.zinc.pred\", \"lz.ok\", \"lz.uk\"),\n    names.attr = c(\"collocated\", \"ordinary\", \"universal\"),\n    cuts=7, col.regions=pal(8)\n))\n\n\n###################################################\n### code chunk number 65: geos.Rnw:1888-1889\n###################################################\nlz.ok <- krige(log(zinc)~1, meuse, meuse.grid, v.fit, block = c(40, 40))\n\n\n###################################################\n### code chunk number 66: geos.Rnw:1905-1908\n###################################################\nxy <- expand.grid(x = seq(-20, 20, 4), y = seq(-20, 20, 4))\nxy <- xy[(xy$x^2 + xy$y^2) <= 20^2, ]\nlz.ok <- krige(log(zinc)~1, meuse, meuse.grid, v.fit, block = xy)\n\n\n###################################################\n### code chunk number 67: geos.Rnw:1921-1922 \n###################################################\n## lz.pols <- krige(log(zinc)~1, meuse, meuse.polygons, v.fit)\n\n\n###################################################\n### code chunk number 68: geos.Rnw:1936-1937 \n###################################################\n## spsample(polygon, n = 500, type = \"regular\", offset = c(.5, .5))\n\n\n###################################################\n### code chunk number 70: geos.Rnw:1988-1989\n###################################################\nmeuse$part.a <- gstat::idw(part.a~1, meuse.grid, meuse, nmax=1)$var1.pred\n\n\n###################################################\n### code chunk number 72: geos.Rnw:2011-2012\n###################################################\nmeuse$part.a <- over(meuse, meuse.grid[\"part.a\"])[[1]]\n\n\n###################################################\n### code chunk number 73: geos.Rnw:2020-2021\n###################################################\nmeuse$part.a <- meuse.grid$part.a[over(meuse, geometry(meuse.grid))]\n\n\n###################################################\n### code chunk number 74: geos.Rnw:2039-2048\n###################################################\nx1 <- krige(log(zinc)~1, meuse[meuse$part.a == 0,],\nmeuse.grid[meuse.grid$part.a == 0,], model = vgm(.548, \"Sph\", 900, .0654),\nnmin = 20, nmax = 40, maxdist = 1000)\nx2 <- krige(log(zinc)~1, meuse[meuse$part.a == 1,],\nmeuse.grid[meuse.grid$part.a == 1,], model = vgm(.716, \"Sph\", 900),\nnmin = 20, nmax = 40, maxdist = 1000)\nlz.stk <- rbind(as.data.frame(x1), as.data.frame(x2))\ncoordinates(lz.stk) <- c(\"x\", \"y\")\nlz.stk <- as(x, \"SpatialPixelsDataFrame\")\n\n\n###################################################\n### code chunk number 75: geos.Rnw:2050-2051 (eval = FALSE)\n###################################################\n## spplot(lz.stk[\"var1.pred\"], main = \"stratified kriging predictions\")\n\n\n###################################################\n### code chunk number 76: geos.Rnw:2067-2070\n###################################################\ng.tr <- gstat(formula = log(zinc) ~ sqrt(dist), data = meuse, model = v.fit)\npredict(g.tr, meuse[1,])\npredict(g.tr, meuse[1,], BLUE = TRUE)\n\n\n###################################################\n### code chunk number 77: geos.Rnw:2090-2091 (eval = FALSE)\n###################################################\n## predict(g, meuse[1,], BLUE = TRUE, debug = 32)\n\n\n###################################################\n### code chunk number 78: geos.Rnw:2104-2112\n###################################################\nmeuse$Int <- rep(1, 155) \ng.tr <- gstat(formula = log(zinc) ~ -1+Int+sqrt(dist), data = meuse, \n   model = v.fit)\nrn <- c(\"Intercept\", \"beta1\")\ndf <- data.frame(Int = c(0,1), dist = c(1,0), row.names=rn)\nspdf <- SpatialPointsDataFrame(SpatialPoints(matrix(0, 2, 2)), df)\nspdf\npredict(g.tr, spdf, BLUE = TRUE)\n\n\n###################################################\n### code chunk number 79: geos.Rnw:2159-2161 (eval = FALSE)\n###################################################\n## library(MASS)\n## boxcox(zinc~sqrt(dist), data=as.data.frame(meuse))\n\n\n###################################################\n### code chunk number 80: geos.Rnw:2179-2180\n###################################################\nmeuse$zinc.ns <- qqnorm(meuse$zinc, plot.it = FALSE)$x\n\n\n###################################################\n### code chunk number 81: geos.Rnw:2207-2212\n###################################################\nind.f <- I(zinc < 500) ~ 1\nind.fit <- fit.variogram(variogram(ind.f, meuse), vgm(1, \"Sph\", 800, 1))\nind.kr <- krige(ind.f, meuse, meuse.grid, ind.fit)\nsummary(ind.kr$var1.pred)\n\n\n\n###################################################\n### code chunk number 82: geos.Rnw:2257-2260 (eval = FALSE)\n###################################################\n## meuse.dup <- rbind(as.data.frame(meuse)[1,], as.data.frame(meuse))\n## coordinates(meuse.dup)=~x+y\n## krige(log(zinc)~1, meuse.dup, meuse[1,], v.fit)\n\n\n###################################################\n### code chunk number 83: geos.Rnw:2287-2289\n###################################################\nmeuse.dup <- rbind(as.data.frame(meuse)[1,], as.data.frame(meuse))\ncoordinates(meuse.dup)=~x+y\n\n\n###################################################\n### code chunk number 84: geos.Rnw:2291-2295\n###################################################\nzd <- zerodist(meuse.dup)\nzd\nmeuse0 <- meuse.dup[-zd[,1],]\nkrige(log(zinc)~1, meuse0, meuse[1,], v.fit)\n\n\n###################################################\n### code chunk number 85: geos.Rnw:2333-2335\n###################################################\nsetL <- list(cn_max=1e10)\nkrige(log(zinc)~1, meuse.dup, meuse[1,], v.fit, set = setL)\n\n\n###################################################\n### code chunk number 86: geos.Rnw:2372-2377\n###################################################\nv <- variogram(log(zinc) ~ 1, meuse)\nv.fit <- fit.variogram(v, vgm(1, \"Sph\", 800, 1))\nv.fit\nlog(meuse$zinc[1])\nkrige(log(zinc)~1, meuse, meuse[1,], v.fit)\n\n\n###################################################\n### code chunk number 87: geos.Rnw:2379-2381\n###################################################\nmeuse_shift = meuse\nmeuse_shift@coords[1,] = meuse@coords[1,] + 1\n\n\n###################################################\n### code chunk number 88: geos.Rnw:2389-2390\n###################################################\nkrige(log(zinc)~1, meuse, meuse_shift[1,], v.fit)\n\n\n###################################################\n### code chunk number 89: geos.Rnw:2416-2419\n###################################################\nerr.fit <- fit.variogram(v, vgm(1, \"Sph\", 800, Err=1))\nerr.fit\nkrige(log(zinc)~1, meuse, meuse[1,], err.fit)\n\n\n###################################################\n### code chunk number 90: geos.Rnw:2435-2439\n###################################################\nv = fit.variogram(v, vgm(1, \"Sph\", 800, Err = .01, nugget = 1),\n   fit.sill = c(FALSE,TRUE,TRUE))\nv\nkrige(log(zinc)~1, meuse[1,], meuse[1,], v)\n\n\n###################################################\n### code chunk number 91: geos.Rnw:2490-2491\n###################################################\nset.seed(1357531)\n\n\n###################################################\n### code chunk number 92: geos.Rnw:2493-2503\n###################################################\nsel100 <- sample(1:155, 100)\nm.model <- meuse[sel100,]\nm.valid <- meuse[-sel100,]\nv100.fit <- fit.variogram(variogram(log(zinc)~1, m.model), vgm(1, \"Sph\", 800,   1))\nm.valid.pr <- krige(log(zinc)~1, m.model, m.valid, v100.fit)\nresid.kr <- log(m.valid$zinc) - m.valid.pr$var1.pred\nsummary(resid.kr)\nresid.mean <- log(m.valid$zinc) - mean(log(m.valid$zinc))\nR2 <- 1 - sum(resid.kr^2)/sum(resid.mean^2)\nR2\n\n\n###################################################\n### code chunk number 93: geos.Rnw:2520-2521\n###################################################\nm.valid.pr$res <- resid.kr \n\n\n###################################################\n### code chunk number 94: geos.Rnw:2523-2524 (eval = FALSE)\n###################################################\n## bubble(m.valid.pr, \"res\")\n\n\n###################################################\n### code chunk number 95: geos.Rnw:2539-2544\n###################################################\nnfold <- 3\npart <- sample(1:nfold, 155, replace = TRUE)\nsel <- (part != 1)\nm.model <- meuse[sel,]\nm.valid <- meuse[-sel,]\n\n\n###################################################\n### code chunk number 96: geos.Rnw:2563-2565\n###################################################\nv.fit <- vgm(.59, \"Sph\", 874, .04)\ncv155 <- krige.cv(log(zinc)~1, meuse, v.fit, nfold=5, verbose=FALSE)\n\n\n###################################################\n### code chunk number 97: geos.Rnw:2567-2568 (eval = FALSE)\n###################################################\n## bubble(cv155, \"residual\", main = \"log(zinc): 5-fold CV residuals\")\n\n\n###################################################\n### code chunk number 98: geos.Rnw:2587-2595\n###################################################\nprint(bubble(cv155, \"residual\", main = \"log(zinc): 5-fold CV residuals\",\n    maxsize = 1.5, col = c(\"green\", \"red\")))\n\n\n###################################################\n### code chunk number 99: geos.Rnw:2608-2609\n###################################################\nsummary(cv155)\n\n\n###################################################\n### code chunk number 100: geos.Rnw:2631-2632 \n###################################################\ng.cv <- gstat.cv(g, nmax=40)\n\n\n###################################################\n### code chunk number 101: geos.Rnw:2673-2675\n###################################################\nv1.fit <- vgm(0.591, \"Sph\", 897, .0507)\nv2.fit <- vgm(0.591, \"Sph\", 897, add.to = vgm(0.0507, \"Sph\", 40))\n\n\n###################################################\n### code chunk number 102: geos.Rnw:2689-2694\n###################################################\nset.seed(13331)\ncv155.1 <- krige.cv(log(zinc)~1, meuse, v1.fit, nfold=5, verbose=FALSE)\nset.seed(13331)\ncv155.2 <- krige.cv(log(zinc)~1, meuse, v2.fit, nfold=5, verbose=FALSE)\nsummary(cv155.1$residual-cv155.2$residual)\n\n\n###################################################\n### code chunk number 103: geos.Rnw:2710-2713\n###################################################\nb1 <- krige(log(zinc)~1, meuse, meuse.grid, v1.fit, block = c(40,40))$var1.var\nb2 <- krige(log(zinc)~1, meuse, meuse.grid, v2.fit, block = c(40,40))$var1.var\nsummary((b1-b2)/b1)\n\n\n###################################################\n### code chunk number 104: geos.Rnw:2820-2821\n###################################################\nlzn.sim <- krige(log(zinc)~1, meuse, meuse.grid, v.fit, nsim = 6, nmax=40)\n\n\n###################################################\n### code chunk number 106: geos.Rnw:2841-2850\n###################################################\nprint(spplot(lzn.sim, col.regions=pal(7), cuts=6))\n\n\n###################################################\n### code chunk number 107: geos.Rnw:2884-2896\n###################################################\narea <-\nstructure(c(181130.059662363, 180917.131281033, 180769.007189672,\n180676.429632572, 180611.625342602, 180463.501251241, 180389.439205561,\n180556.078808342, 180694.945143992, 180796.780456802, 180824.553723932,\n180898.615769613, 181000.451082423, 181130.059662363, 181241.152730884,\n181268.925998014, 181194.863952334, 181130.059662363, 333718.312421053,\n333491.307789474, 333245.386105263, 332990.005894737, 332781.918315789,\n332554.913684211, 332498.162526316, 332413.035789474, 332592.747789474,\n332810.293894737, 333008.922947368, 333188.634947368, 333358.888421053,\n333491.307789474, 333566.976, 333614.268631579, 333793.980631579,\n333718.312421053), .Dim = as.integer(c(18, 2)))\narea.sp = SpatialPolygons(list(Polygons(list(Polygon(area)), \"area\")))\n\n\n###################################################\n### code chunk number 108: geos.Rnw:2898-2905\n###################################################\n# set eval=TRUE if change; this section is repeated in the FIG code\nnsim <- 1000\ncutoff <- 500\nsel.grid <- meuse.grid[area.sp, ]\nlzn.sim <- krige(log(zinc)~1, meuse, sel.grid, v.fit, nsim = nsim, nmax=40)\nres <- apply(as.data.frame(lzn.sim)[1:nsim], 2, function(x) mean(x >            \nlog(cutoff)))\n\n\n###################################################\n### code chunk number 109: geos.Rnw:2907-2908 (eval = FALSE)\n###################################################\n## hist(res, main = paste(\"fraction above\", cutoff), xlab = NULL, ylab = NULL)\n\n\n###################################################\n### code chunk number 110: geos.Rnw:2922-2924\n###################################################\nbkr <- krige(log(zinc)~1, meuse, area.sp, v.fit)\n1 - pnorm(log(cutoff), bkr$var1.pred, sqrt(bkr$var1.var))\n\n\n###################################################\n### code chunk number 111: geos.Rnw:2930-2943\n###################################################\nlayout(matrix(1:2, 1, 2))\nomar <- par(\"mar\")\npar(mar = rep(0,4))\nimage(meuse.grid[\"part.a\"], col = 'gray') #$\nlines(area, col = 'red')\npar(mar = c(2,2,0.5,0)+.1)\nhist(res, main = NULL, xlab = NULL, ylab = NULL)\npar(mar = omar)\n\n\n###################################################\n### code chunk number 112: geos.Rnw:2982-2986\n###################################################\ntable(meuse$soil) #$\ns1.fit <- fit.variogram(variogram(I(soil==1)~1,meuse), vgm(1, \"Sph\", 800, 1))\ns1.sim <- krige(I(soil==1)~1, meuse, meuse.grid, s1.fit, nsim = 6, \n   indicators = TRUE, nmax = 40)\n\n\n###################################################\n### code chunk number 114: geos.Rnw:3006-3014\n###################################################\nprint(spplot(s1.sim, cuts=1, col.regions=pal(3)[c(1,3)]))\n\n\n###################################################\n### code chunk number 115: geos.Rnw:3064-3067 (eval = FALSE)\n###################################################\n## m1 <- sapply(1:155, function(x) mean(krige(log(zinc)~1, meuse[-x,],\n##     meuse.grid, v.fit)$var1.var))\n## which(m1 == min(m1)) #$\n\n\n###################################################\n### code chunk number 116: geos.Rnw:3081-3082 (eval = FALSE)\n###################################################\n## plot(sort(m1))\n\n\n###################################################\n### code chunk number 117: geos.Rnw:3098-3105 (eval = FALSE)\n###################################################\n## cutoff <- 1000\n## f <- function(x) {\n##     kr = krige(log(zinc)~1, meuse[-x,], meuse.grid, v.fit)\n##     mean(abs(pnorm((kr$var1.pred - log(cutoff))/sqrt(kr$var1.var)) - 0.5))\n## }\n## m2 <- sapply(1:155, f)\n## which(m2 == max(m2))\n\n\n###################################################\n### code chunk number 118: geos.Rnw:3111-3130\n###################################################\nsource(\"m1m2.R\")\nlayout(matrix(1:2, 1, 2))\nomar <- par(\"mar\")\npar(mar = rep(0,4))\nimage(meuse.grid, col = grey(.8))\npoints(meuse)\npoints(meuse[m1 < quantile(m1,.1),], pch=1, col = 'red')\npoints(meuse[m1 > quantile(m1,.9),], pch=16, col = 'darkgreen')\nimage(meuse.grid, col = grey(.8))\npoints(meuse)\npoints(meuse[m2 < quantile(m2,.1),], pch=16, col = 'darkgreen')\npoints(meuse[m2 > quantile(m2,.9),], pch=1, col = 'red')\npar(mar = omar)\n\n\n###################################################\n### code chunk number 119: geos.Rnw:3221-3223\n###################################################\nlibrary(RandomFields)\nver <- packageDescription(\"RandomFields\")$Version\n\n\n###################################################\n### code chunk number 120: geos.Rnw:3237-3238 \n###################################################\nPrintModelList()\n\n\n###################################################\n### code chunk number 121: geos.Rnw:3270-3272 \n###################################################\nlibrary(geoR)\nplot(variog(as.geodata(meuse[\"zinc\"]), max.dist=1500))\n\n\n###################################################\n### code chunk number 122: geos.Rnw:3319-3320 (eval = FALSE)\n###################################################\n## vignette(\"st\", package = \"gstat\")\n\n\n\n",
    "created" : 1392011385331.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1625346453",
    "id" : "61C53BEB",
    "lastKnownWriteTime" : 1392272724,
    "path" : "D:/Dropbox/Research/Codes/R/SpatialData/Chapter8/geos_mod.R",
    "project_path" : "geos_mod.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}